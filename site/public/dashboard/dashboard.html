<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="dashboards.css">
  <script src="../javascript/script.js"></script>

  <script src="../js/funcoes.js"></script>
  <script src="../js/alerta.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <!-- scripts do Chart.js - 2022-1 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!--FONT AWESOME-->
  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body onload="">
  <!-- ; validarSessao() -->
  <div class="header">
    <div class="container">
      <h1 class="icon1">
        <a href="../index.html"> <img class="img1" src="../assets/img/SE34-2.png"></a>
      </h1>
      <div class="navbar">
        <div class="hello">
          <h3> <span id="b_usuario" style="font-size: 20px;">usuário</span></h3>
        </div>
        <!-- <div class="perfil"></div> -->
        <a href="dashboard.html">
          <img width="35px" height="35px" src="../assets/img/home_FILL0_wght400_GRAD0_opsz48.png" alt="">
         </a>
        <div class="dropdown">
          <button class="dropbtn" onclick="mostrartrucks()"><img
            src='../assets/img/free-truck-icon-1058-thumb.png' height="45px" width="45px" /></button>
            <div class="dropdown-content" id="caminhaoes">
              <a href="caminhao.html" onclick="caminhãoA1()" style="color: red;"> Caminhão A1</a>
              <a href="caminhao.html" onclick="caminhãoA2()" style="color: #ff7b00;">Caminhão A2</a>
              <a href="caminhao.html" onclick="caminhãoA3()" style="color: green;">Caminhão A3</a>
              <a href="caminhao.html" onclick="caminhãoA4()" style="color: green;">Caminhão A4</a>
            </div>
        </div>

         <a onclick="limparSessao()"><img src="https://cdn-icons-png.flaticon.com/512/126/126467.png" alt="" height="31px"></a>
       </div>
      </div>
      
  </div>
  </div>
  </div>


  <div class="body1">

    <div class="esquerda">
      <div class="separa">
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Temperatura Atual
          </div>
          <span class="kpi">
            - 5°C
          </span>
        </div>
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Umidade Atual
          </div>
          <span class="kpi">
            80%
          </span>
        </div>

      </div>
      <div class="rosca">
        <canvas id="donuts-1"></canvas>
      </div>
    </div>

    <div class="meio">
      <div class="painel">
        <h2><b>Painel Geral</b> </h2>
        <div class="aviso ao_redor">
          <p> <b> Atenção!</b><br> O caminhão <b>A2</b> está precisando de atenção e o <b>A1</b> está crítico, fazer
            algo para reverter urgente.</p>
        </div>
      </div>
      <div class="tituloB2 b3">
        <h1><b>Anual Geral</b> </h1>
      </div>
      <div class="grafico1">

        <div>
          <canvas id="myChart3"></canvas>
        </div>
      </div>
    </div>

    <div class="direita">
      <div class="separa">
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Quantidade de Caminhões
          </div>
          <span id="kpiQTD" class="kpi" style="color: black;">
            0
          </span>
        </div>
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Situação Geral
          </div>
          <span class="kpi2">
            Na média
          </span>
        </div>
      </div>
      <div class="rosca">
        <canvas id="donuts-2"></canvas>
      </div>
    </div>

  </div>
  <div class="tituloB2">
    <h1><b>Gelo</b> </h1>
    <h1><b>Nitrogênio</b> </h1>
  </div>

  <div class="body2">

    <div class="grafico2">
      <canvas id="myChart2000"></canvas>
    </div>

    <div class="grafico2">
      <canvas id="myChart2001"></canvas>
    </div>
  </div>

  <footer>
    <p>
      <b> Copyright ©️ SE34 | Todos os direitos reservado.</b>
    </p>
  </footer>
</body>

</html>
<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  token = sessionStorage.TOKEN_USUARIO;

  Chart.defaults.font.weight = 'bold';
  Chart.defaults.color = '#000';
  Chart.defaults.font.family = 'Times New Roman';
  Chart.defaults.font.size = 16;

  buscarQtdCaminhao();
  buscarStatSensor();
  buscarTipoCaminhao();

  // const ctx = document.getElementById('myChart1');

  // new Chart(ctx, {
  //   type: 'line',
  //   data: {
  //     labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
  //     datasets: [{
  //       label: ' Temperatura',
  //       borderColor: '#022841',
  //       backgroundColor: '#022841',
  //       data: [0, 0, -1, 5, -5, -2, 2, -6],
  //       borderWidth: 3,
  //     },
  //     {
  //       label: 'Umidade',
  //       borderColor: '#0f65bb',
  //       backgroundColor: '#0f65bb',
  //       data: [80, 82, 90, 85, 80, 83],
  //       borderWidth: 3
  //     }]
  //   },
  //   options: {
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // });


  // const ctx2 = document.getElementById('myChart2');

  // new Chart(ctx2, {
  //   type: 'line',
  //   data: {
  //     labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
  //     datasets: [
  //       {
  //         label: 'Temperatura ',
  //         borderColor: '#022841',
  //         backgroundColor: '#022841',
  //         data: [-1, 0, -2, -3, 0, -18],
  //         borderWidth: 3
  //       },

  //       {
  //         label: 'Umidade ',
  //         data: [90, 89, 93, 87, 88, 82],
  //         borderColor: '#0f65bb',
  //         backgroundColor: '#0f65bb',
  //         borderWidth: 3
  //       }]
  //   },
  //   options: {
  //     scales: {
  //       y: {
  //         beginAtZero: true
  //       }
  //     }
  //   }
  // });
  const ctx3 = document.getElementById('myChart3');

  new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho'],
      datasets: [{
        label: ' Temperatura Média',
        borderColor: '#022841',
        backgroundColor: '#022841',
        data: [-1, 0, -2, 5, -18, -15, -10],
        borderWidth: 3,

      },
      {
        label: 'Umidade Média',
        borderColor: '#0f65bb',
        backgroundColor: '#0f65bb',
        data: [80, 82, 80, 85, 90, 91],
        borderWidth: 3
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });


  function plotarPizza2() {

    ativo = sessionStorage.STATSENSORATIVO
    inativo = sessionStorage.STATSENSORINATIVO
    manutencao = sessionStorage.STATSENSORMANUTENCAO

    /* -- Gráfico de Rosca -- */
    const chart = new Chart('donuts-2', {
      type: 'doughnut', // Aqui muda o tipo do gráfico, os mais comuns são 'line', 'bar', 'pizza', 'radio', 'doughnut'
      data: {
        labels: ['Ativo', 'Inativo', 'Manutenção'], // Aqui serve para definir quais são os dados que você quer guardar
        datasets: [{
          label: 'Sensores', // Aqui é mais para um nome geral
          data: [ativo, inativo, manutencao], // Dados das "labels", qualquer valor é "100%" você não precisa ter um somatório de 100 números para dar 100%, não é assim que porcentagem funciona, porcentagem é flexível e depende do seu valor final, se 50 for o total de coisas que você tem, logo ela é o seu 100%, metade disso (50%) seria 25 coisas
          backgroundColor: ['#008000', '#A9A9A9', '#FFD700'], // Cor  do fundo
          borderColor: ['#008000', '#A9A9A9', '#FFD700'], // Cor da borda
        }
        ]
      },
      options: {
        maintainAspectRatio: false,
      }
    });
  }

  function plotarPizza1() {

    var gelo = sessionStorage.TIPOCAMINHAOGELO
    var nitro = sessionStorage.TIPOCAMINHAONITRO


    const chart1 = new Chart('donuts-1', {
      type: 'doughnut', // Aqui muda o tipo do gráfico, os mais comuns são 'line', 'bar', 'pizza', 'radio', 'doughnut'
      data: {
        labels: ['Caminhões com Gelo', 'Caminhões com Nitrogênio'], // Aqui serve para definir quais são os dados que você quer guardar
        datasets: [{
          label: 'Alertas ',
          data: [gelo, nitro], // Dados das "labels", qualquer valor é "100%" você não precisa ter um somatório de 100 números para dar 100%, não é assim que porcentagem funciona, porcentagem é flexível e depende do seu valor final, se 50 for o total de coisas que você tem, logo ela é o seu 100%, metade disso (50%) seria 25 coisas
          backgroundColor: ['#022841', '#0f65bb'], // Cor  do fundo
          borderColor: ['#022841', '#0f65bb'], // Cor da borda
        }
        ]
      },
      options: {
        maintainAspectRatio: false,
      }
    });
  }


  // PARA CAPTURAR OS DADOS DO BANCO COMEÇA AQUI

  let proximaAtualizacao;

  window.onload = obterDadosGraficos();

  function obterDadosGraficos() {
    obterDadosGrafico(2000)
    obterDadosGrafico(2001)
    // obterDadosGrafico(3)
    // obterDadosGrafico(4)
  }

  // verificar_autenticacao();

  // function alterarTitulo(token) {
  //     var tituloAquario = document.getElementById(`tituloAquario${token}`)
  //     tituloAquario.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>Aquário " + token + "</span>"
  // }

  //     // function exibirAquario(token) {
  //     //     let todosOsGraficos = document.getElementById("graficos")

  //     //     for (i = 1; i <= todosOsGraficos.childElementCount; i++) {
  //     //         // exibindo - ou não - o gráfico
  //     //         let elementoAtual = document.getElementById(`grafico${i}`)
  //     //         if (elementoAtual.classList.contains("display-block")) {
  //     //             elementoAtual.classList.remove("display-block")
  //     //         }
  //     //         elementoAtual.classList.add("display-none")

  //     //         // alterando estilo do botão
  //     //         let btnAtual = document.getElementById(`btnAquario${i}`)
  //     //         if (btnAtual.classList.contains("btn-pink")) {
  //     //             btnAtual.classList.remove("btn-pink")
  //     //         }
  //     //         btnAtual.classList.add("btn-white")
  //     //     }

  // // exibindo - ou não - o gráfico
  // let graficoExibir = document.getElementById(`grafico${token}`)
  // graficoExibir.classList.remove("display-none")
  // graficoExibir.classList.add("display-block")

  // // alterando estilo do botão
  // let btnExibir = document.getElementById(`btnAquario${token}`)
  // btnExibir.classList.remove("btn-white")
  // btnExibir.classList.add("btn-pink")
  // }

  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGrafico() {

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${token}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, token);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // // // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // // // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // // // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, token) {

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Umidade',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      },
      {
        label: 'Temperatura',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
      }]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.momento_grafico);
      dados.datasets[0].data.push(registro.umidade);
      dados.datasets[1].data.push(registro.temperatura);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: dados,
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`myChart${token}`),
      config
    );

   








    // Criando estrutura para plotar gráfico - labels
    let labels2 = [];

    // Criando estrutura para plotar gráfico - dados
    let dados2 = {
      labels: labels,
      datasets: [{
        label: 'Umidade',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      },
      {
        label: 'Temperatura',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
      }]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.momento_grafico);
      dados2.datasets[0].data.push(registro.umidade);
      dados2.datasets[1].data.push(registro.temperatura);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config2 = {
      type: 'line',
      data: dados2,
    };

    // Adicionando gráfico criado em div na tela
    let myChart2 = new Chart(
      document.getElementById(`myChart2001`),
      config
    );

    setTimeout(() => atualizarGrafico(token, dados, dados2, myChart, myChart2), 2000);
  }


  // // // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // // // buscando a última medida inserida em tabela contendo as capturas, 

  // // //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  // // //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(token, dados, dados2, myChart, myChart2) {



    fetch(`/medidas/tempo-real/${token}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados);

          // let avisoCaptura = document.getElementById(`avisoCaptura${token}`)


          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {
            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

            dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

            myChart.update();
          }

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(token, dados, myChart), 2000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(token, dados, myChart), 2000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });




      fetch(`/medidas/tempo-real/${token}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados2);

          // let avisoCaptura = document.getElementById(`avisoCaptura${token}`)


          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {
            // tirando e colocando valores no gráfico
            dados2.labels.shift(); // apagar o primeiro
            dados2.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

            dados2.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados2.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

            dados2.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados2.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

            myChart2.update();
          }

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(token, dados2, myChart2), 2001);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(token, dados2, myChart2), 2001);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  function buscarQtdCaminhao() {
    // aguardar();

    fetch(`/medidas/tempo-real-3/${token}`
    ).then(function (resposta) {

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.QTDCAMINHAO = json[0].qtdCaminhao;
        });

      } else {

        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          // finalizarAguardar(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }
  function buscarStatSensor() {
    // aguardar();

    fetch(`/medidas/tempo-real-2/${token}`
    ).then(function (resposta) {

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.STATSENSORATIVO = json[0].tipoSensor;
          sessionStorage.STATSENSORINATIVO = json[1].tipoSensor;
          sessionStorage.STATSENSORMANUTENCAO = json[2].tipoSensor;
        });

      } else {

        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          // finalizarAguardar(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }
  function buscarTipoCaminhao() {
    // aguardar();

    fetch(`/medidas/tempo-real-1/${token}`
    ).then(function (resposta) {

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.TIPOCAMINHAOGELO = json[0].tipoCaminhao;
          sessionStorage.TIPOCAMINHAONITRO = json[1].tipoCaminhao;

          plotar()

        });

      } else {

        console.log("Houve um erro ao tentar realizar o login!");

        resposta.text().then(texto => {
          console.error(texto);
          // finalizarAguardar(texto);
        });
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  function plotar() {
    kpiQTD.innerHTML = sessionStorage.QTDCAMINHAO

    plotarPizza1()

    plotarPizza2()
  }



</script>
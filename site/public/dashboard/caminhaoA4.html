<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caminhão A4</title>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <link rel="stylesheet" href="style.css">
  <script src="../js/funcoes.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <!-- scripts do Chart.js - 2022-1 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!--FONT AWESOME-->
  <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="dashboards.css">
</head>

<body>
  <div class="header">
    <div class="container">
      <h1 class="icon1">
        <a href="dashboard.html"> <img class="img1" src="../assets/img/SE34-2.png"></a>
      </h1>
      <div class="navbar">
        <a href="dashboard.html">
          <li><img width="30px" height="30px" src="../assets/img/home_FILL0_wght400_GRAD0_opsz48.png" alt="">
          </li>
        </a>
        <div class="hello">
          <h3> <span id="b_usuario" style="font-size: 20px;">usuário</span></h3>
        </div>
        <!-- <div class="perfil"></div> -->

        <!-- <div class="dropdown">
          <button class="mainmenubtn"><img src='../assets/img/perfil-de-usuario (1).png' height="60px"
              width="60px"></button>
          <div class="dropdown-child">
            <a href="caminhao1.html" style="color: red;"> Caminhão A1</a>
            <a href="caminhao.html" style="color: #ff7b00;">Caminhão A2</a>
            <a href="caminhao3.html" style="color: green;">Caminhão A3</a>
            <a href="caminhao4.html" style="color: green;">Caminhão A4</a>
          </div>
        </div> -->

        <div class="dropdown">
          <button id="icone" class="dropbtn"><img src='../assets/img/perfil-de-usuario (1).png' height="60px"
            width="60px">
            <div class="dropdown-content">
              <a href="caminhaoA1.html" style="color: red;"> Caminhão A1</a>
              <a href="caminhaoA2.html" style="color: #ff7b00;">Caminhão A2</a>
              <a href="caminhaoA3.html" style="color: green;">Caminhão A3</a>
              <a href="caminhaoA4.html" style="color: green;">Caminhão A4</a>
          </div>
          </div>
        </div>

        <li><a href="../index.html" onclick="limparSessao()"><b>Sair</b></a></li>
      </div>
    </div>
  </div>
  </div>
  </div>



  <div class="body1">

    <div class="esquerda">
      <div class="separa">
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Temperatura Atual
          </div>
          <span class="kpi" style="color: #ff7b00;">
            0,5°C
          </span>
        </div>
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Umidade Atual
          </div>
          <span class="kpi" style="color: #ff7b00;">
            70%
          </span>
        </div>

      </div>
      <div class="rosca">
        <canvas id="donuts1"></canvas>
      </div>
    </div>

    <div class="meio">
      <div class="painel">
        <h2><b>Painel Geral</b> </h2>
        <div class="aviso ao_redor">
          <p> <b>Atenção!</b> <br>O sensor do caminhão A2 está capitando um temperatura acima de 0ºC,<br>
            ficar atento pois quando chegar em 1.5°C o gelo pode descongelar. Tomar atitude antes que fique pior</p>
        </div>
        <div class="tituloB2 b3">
          <h1><b>Anual</b> </h1>
        </div>
      </div>
      <div class="grafico1">
        <div>
          <canvas id="myChart3"></canvas>
        </div>
      </div>
    </div>

    <div class="direita">
      <div class="separa">
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Quantidade de Sensores
          </div>
          <span class="kpi" style="color: #110f08;">
            3
          </span>
        </div>
        <div class="box_kpi ao_redor">
          <div class=" titulokpi">
            Situação Geral
          </div>
          <span class="kpi2 " style="color: #ffc400;">
            Atenção
          </span>
        </div>
      </div>
      <div class="rosca">
        <canvas id="donuts2"></canvas>
      </div>
    </div>

  </div>
  <div class="tituloB2">
    <h1><b>Mensal</b> </h1>
    <h1><b>Diário</b> </h1>
  </div>

  <div class="body2">

    <div class="grafico2">
      <canvas id="myChart1"></canvas>
    </div>

    <div class="grafico2">
      <canvas id="myChart2"></canvas>
    </div>
  </div>

  <footer>
    <p>
      <b> Copyright ©️ SE34 | Todos os direitos reservado.</b>
    </p>
  </footer>
</body>

</html>
<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  Chart.defaults.font.weight = 'bold';
  Chart.defaults.color = '#000';
  Chart.defaults.font.family = 'Times New Roman';
  Chart.defaults.font.size = 16;

  const ctx = document.getElementById('myChart1');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['1°dia', '2°dia', '3°dia', '4°dia', '5°dia', '6°dia'],
      datasets: [{
        label: ' Temperatura',
        borderColor: '#022841',
        backgroundColor: '#022841',
        data: [0, 0, -1, 5, -5, -2, 2, -6],
        borderWidth: 3,

      },
      {
        label: 'Umidade',
        borderColor: '#0f65bb',
        backgroundColor: '#0f65bb',
        data: [80, 82, 90, 85, 80, 83],
        borderWidth: 3
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  const ctx2 = document.getElementById('myChart2');

  new Chart(ctx2, {
    type: 'line',
    data: {
      labels: ['12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
      datasets: [
        {
          label: 'Temperatura ',
          borderColor: '#022841',
          backgroundColor: '#022841',
          data: [-1, 0, -2, -3, 0, -18],
          borderWidth: 3
        },

        {
          label: 'Umidade ',
          data: [90, 89, 93, 87, 88, 82],
          borderColor: '#0f65bb',
          backgroundColor: '#0f65bb',
          borderWidth: 3
        }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
  const ctx3 = document.getElementById('myChart3');

  new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho'],
      datasets: [{
        label: ' Temperatura Média',
        borderColor: '#022841',
        backgroundColor: '#022841',
        data: [-1, 0, -2, 5, -18, -15, -10],
        borderWidth: 3,

      },
      {
        label: 'Umidade Média',
        borderColor: '#0f65bb',
        backgroundColor: '#0f65bb',
        data: [80, 82, 80, 85, 90, 91],
        borderWidth: 3
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });

  /* -- Gráfico de Rosca -- */
  const chart = new Chart('donuts2', {
    type: 'doughnut', // Aqui muda o tipo do gráfico, os mais comuns são 'line', 'bar', 'pizza', 'radio', 'doughnut'
    data: {
      labels: ['Ativo', 'Inativo', 'Manutenção'], // Aqui serve para definir quais são os dados que você quer guardar
      datasets: [{
        label: 'Sensores', // Aqui é mais para um nome geral
        data: [1, 1, 1], // Dados das "labels", qualquer valor é "100%" você não precisa ter um somatório de 100 números para dar 100%, não é assim que porcentagem funciona, porcentagem é flexível e depende do seu valor final, se 50 for o total de coisas que você tem, logo ela é o seu 100%, metade disso (50%) seria 25 coisas
        backgroundColor: ['#008000', '#A9A9A9', '#FFD700'], // Cor  do fundo
        borderColor: ['#008000', '#A9A9A9', '#FFD700'], // Cor da borda
      }
      ]
    },
    options: {
      maintainAspectRatio: false,
    }
  });

  const chart1 = new Chart('donuts1', {
    type: 'doughnut', // Aqui muda o tipo do gráfico, os mais comuns são 'line', 'bar', 'pizza', 'radio', 'doughnut'
    data: {
      labels: ['Alertas', 'Normal'], // Aqui serve para definir quais são os dados que você quer guardar
      datasets: [{
        label: 'Alertas ',
        data: [5, 4], // Dados das "labels", qualquer valor é "100%" você não precisa ter um somatório de 100 números para dar 100%, não é assim que porcentagem funciona, porcentagem é flexível e depende do seu valor final, se 50 for o total de coisas que você tem, logo ela é o seu 100%, metade disso (50%) seria 25 coisas
        backgroundColor: ['#022841', '#0f65bb'], // Cor  do fundo
        borderColor: ['#022841', '#0f65bb'], // Cor da borda
      }
      ]
    },
    options: {
      maintainAspectRatio: false,
    }
  });



























  let proximaAtualizacao;

  window.onload = obterDadosGraficos();

  function obterDadosGraficos() {
    obterDadosGrafico(1)
    obterDadosGrafico(2)
    obterDadosGrafico(3)
    obterDadosGrafico(4)
  }

  // verificar_autenticacao();

  // function alterarTitulo(idCaminhao) {
  //     var tituloAquario = document.getElementById(`tituloAquario${idCaminhao}`)
  //     tituloAquario.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>Aquário " + idCaminhao + "</span>"
  // }

  // function exibirAquario(idCaminhao) {
  //     let todosOsGraficos = document.getElementById("graficos")

  //     for (i = 1; i <= todosOsGraficos.childElementCount; i++) {
  //         // exibindo - ou não - o gráfico
  //         let elementoAtual = document.getElementById(`grafico${i}`)
  //         if (elementoAtual.classList.contains("display-block")) {
  //             elementoAtual.classList.remove("display-block")
  //         }
  //         elementoAtual.classList.add("display-none")

  //         // alterando estilo do botão
  //         let btnAtual = document.getElementById(`btnAquario${i}`)
  //         if (btnAtual.classList.contains("btn-pink")) {
  //             btnAtual.classList.remove("btn-pink")
  //         }
  //         btnAtual.classList.add("btn-white")
  //     }

  //     // exibindo - ou não - o gráfico
  //     let graficoExibir = document.getElementById(`grafico${idCaminhao}`)
  //     graficoExibir.classList.remove("display-none")
  //     graficoExibir.classList.add("display-block")

  //     // alterando estilo do botão
  //     let btnExibir = document.getElementById(`btnAquario${idCaminhao}`)
  //     btnExibir.classList.remove("btn-white")
  //     btnExibir.classList.add("btn-pink")
  // }

  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
var idCaminhao = 1;

  function obterDadosGrafico() {

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${idCaminhao}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, idCaminhao);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idCaminhao) {

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Umidade',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      },
      {
        label: 'Temperatura',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
      }]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.momento_grafico);
      dados.datasets[0].data.push(registro.umidade);
      dados.datasets[1].data.push(registro.temperatura);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: dados,
    };

    // Adicionando gráfico criado em div na tela
    let myChart1 = new Chart(
      document.getElementById(`myChartCanvas${idCaminhao}`),
      config
    );

    setTimeout(() => atualizarGrafico(idCaminhao, dados, myChart1), 2000);
  }


  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas, 

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(idCaminhao, dados, myChart1) {



    fetch(`/medidas/tempo-real/${idCaminhao}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
          console.log(`Dados atuais do gráfico:`);
          console.log(dados);

          let avisoCaptura = document.getElementById(`avisoCaptura${idCaminhao}`)
          avisoCaptura.innerHTML = ""


          if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
            console.log("Horário do novo dado capturado:")
            console.log(novoRegistro[0].momento_grafico)
            console.log("Horário do último dado capturado:")
            console.log(dados.labels[dados.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {
            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

            dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

            myChart.update();
          }

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idCaminhao, dados, myChart1), 2000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idCaminhao, dados, myChart1), 2000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }
</script>